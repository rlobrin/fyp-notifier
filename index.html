<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYP Notifier (Dual Scan)</title>
    
    <!-- Tab Icon -->
    <link rel="icon" href="page icon.jpg" type="image/jpeg">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* Global Reset for full height app */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent body scrollbar */
            background-color: var(--bs-tertiary-bg); /* Adaptive background */
            color: var(--bs-body-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Main App Grid --- */
        .app-grid-layout {
            display: grid;
            gap: 15px;
            /* 3 Columns: 1.5fr, 1fr, 1fr */
            grid-template-columns: 1.5fr 1fr 1fr; 
            /* Rows: Tabs (auto), Content (remaining space) */
            grid-template-rows: auto 1fr; 
            height: 98vh; 
            width: 98%;
            margin: 1vh auto;
            box-sizing: border-box;
        }

        /* --- Grid Areas --- */
        .area-tabs { 
            grid-column: 1 / -1; 
            grid-row: 1; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bs-border-color);
            padding-bottom: 5px;
        }
        
        /* The main content container must strictly fill the remaining row height */
        .area-content { 
            grid-column: 1 / -1; 
            grid-row: 2; 
            min-height: 0; 
            height: 100%; 
            overflow: hidden; 
            background: var(--bs-body-bg); /* Adaptive background */
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
            padding: 0; 
        }

        /* --- Tab System --- */
        .nav-tabs {
            border-bottom: none;
        }
        .tab-content-wrapper {
            height: 100%;
            width: 100%;
            display: none;
            overflow-y: auto; 
            padding: 1rem;
        }
        .tab-content-wrapper.active { display: block; }

        /* --- Internal Grids --- */
        .main-tab-grid {
            display: grid;
            gap: 15px;
            grid-template-columns: 1.5fr 1fr 1fr; 
            grid-template-rows: 1fr; /* Fill height */
            height: 100%;
        }

        .moon-tab-grid {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr; /* Fill height */
            height: 100%;
        }

        /* --- Custom UI Elements --- */
        .console-log {
            background-color: #212529;
            color: #00ff00;
            font-family: monospace;
            font-size: 0.8rem;
            resize: none;
            border: 1px solid #495057;
        }

        .capture-canvas-container {
            border: 2px dashed var(--bs-border-color);
            background: var(--bs-tertiary-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden; /* Changed from auto to hidden to control child size better */
            position: relative;
        }

        /* --- List Section Styling --- */
        .list-split-wrapper {
            flex: 1 1 auto; 
            height: 0; 
            min-height: 0;
            display: flex;
            gap: 0.5rem;
        }

        .list-section {
            flex: 1; /* Share width equally */
            display: flex;
            flex-direction: column;
            height: 100%; /* Fill the wrapper height */
            border: 1px solid var(--bs-border-color);
            border-radius: 4px;
            background-color: var(--bs-body-bg);
            overflow: hidden; /* Contain children */
        }

        .list-section-header { flex-shrink: 0; }
        .list-scroll-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            background-color: var(--bs-body-bg);
            /* Scrollbar styling for Webkit */
            scrollbar-width: thin;
        }

        /* --- Generic Slide-to-Reveal Styling (Buttons slide IN from right) --- */
        .slide-reveal-wrapper {
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--bs-border-color);
            background-color: var(--bs-body-bg);
            padding: 0;
            cursor: pointer;
        }
        .slide-reveal-wrapper:last-child {
            border-bottom: none;
        }
        
        .slide-reveal-content {
            position: relative;
            z-index: 1;
            background-color: var(--bs-body-bg);
            width: 100%;
            /* Content stays put so text remains visible */
        }

        .slide-reveal-action {
            position: absolute;
            top: 0;
            right: -100px; /* Initially hidden off-screen to the right */
            height: 100%;
            width: 100px; 
            background-color: var(--bs-body-bg);
            display: flex;
            z-index: 10; /* On top of content */
            transition: right 0.2s ease-out;
        }
        
        /* Hover Effect: Slide Buttons IN from Right */
        .slide-reveal-wrapper:hover .slide-reveal-action {
            right: 0;
        }
        
        .slide-btn {
            width: 50%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .slide-btn-edit { background-color: #6c757d; }
        .slide-btn-edit:hover { background-color: #5c636a; }
        .slide-btn-delete { background-color: #dc3545; }
        .slide-btn-delete:hover { background-color: #bb2d3b; }

        /* --- Modal Styling --- */
        .custom-modal-overlay {
            display: none; 
            position: fixed; 
            z-index: 1055; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(2px);
            align-items: center; 
            justify-content: center; 
        }

        .custom-modal-dialog {
            background: var(--bs-body-bg);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
            color: var(--bs-body-color);
        }

        .custom-modal-lg { max-width: 800px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--bs-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bs-tertiary-bg);
        }

        .custom-modal-body { padding: 1.5rem; overflow-y: auto; }

        .webhook-select-item {
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .webhook-select-item:hover { background-color: var(--bs-tertiary-bg) !important; }

        /* --- TOAST NOTIFICATIONS --- */
        .toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 1060;
            display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .custom-toast {
            background: rgba(33, 37, 41, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 12px;
            min-width: 280px; max-width: 350px;
            animation: slideInToast 0.3s ease-out forwards;
            font-size: 0.9rem; pointer-events: auto;
            border-left: 4px solid #6c757d;
        }
        .custom-toast.success { border-left-color: #198754; }
        .custom-toast.error { border-left-color: #dc3545; }
        .custom-toast.info { border-left-color: #0dcaf0; }

        @keyframes slideInToast {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOutToast {
            to { opacity: 0; transform: translateY(10px); }
        }

        .min-h-0 { min-height: 0 !important; }

        /* Zoom Badge Overlay in Preview */
        .zoom-badge {
            position: absolute;
            top: 5px; right: 5px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        /* Scoped Scrollbar Helper */
        .scroll-y-auto {
            overflow-y: auto;
            min-height: 0; /* Important for flex children to shrink */
        }

        @media (max-width: 992px) {
            html, body { height: auto; overflow: auto; }
            .app-grid-layout {
                display: flex; flex-direction: column;
                height: auto; margin: 10px; width: auto;
            }
            .area-content { height: auto; overflow: visible; }
            .main-tab-grid, .moon-tab-grid { display: flex; flex-direction: column; height: auto; }
            .list-split-wrapper { flex-direction: column; height: auto; }
            .list-section { height: 250px; flex: none; }
        }
    </style>
</head>
<body>

    <div class="app-grid-layout">
        <div class="area-tabs">
            <ul class="nav nav-tabs border-bottom-0">
                <li class="nav-item">
                    <a class="nav-link active fw-bold" href="#" onclick="openTab(event, 'mainTab')"><i class="bi bi-camera-video"></i> Main Scanner</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-body" href="#" onclick="openTab(event, 'moonWeatherTab')"><i class="bi bi-list-ul"></i> Moons/Weathers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-body" href="#" onclick="openTab(event, 'settingsTab')"><i class="bi bi-gear"></i> Settings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-body" href="#" onclick="openTab(event, 'aboutTab')"><i class="bi bi-info-circle"></i> About</a>
                </li>
            </ul>
            <div class="pe-2">
                <button class="btn btn-outline-secondary btn-sm rounded-circle" onclick="toggleTheme()" id="themeToggleBtn" title="Toggle Light/Dark Mode">
                    <i class="bi bi-sun-fill" id="themeIcon"></i>
                </button>
            </div>
        </div>

        <div class="area-content">
            
            <div id="mainTab" class="tab-content-wrapper active">
                <div class="main-tab-grid">
                    
                    <div class="d-flex flex-column gap-2 h-100">
                        <div class="card h-100 shadow-sm border-0 bg-transparent"> 
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-body-tertiary fw-bold py-2 small text-uppercase">
                                    <i class="bi bi-cast"></i> Screen Source
                                </div>
                                <div class="card-body d-flex flex-column gap-2 overflow-hidden p-2">
                                    
                                    <div class="overflow-auto pe-1" style="max-height: 60%;"> 
                                        <div class="d-flex gap-2 mb-2">
                                            <button id="connectScreenButton" onclick="connectScreen()" class="btn btn-primary w-50 btn-sm">
                                                <i class="bi bi-display"></i> Connect
                                            </button>
                                            <button id="processButton" onclick="toggleProcess()" disabled class="btn btn-success w-50 btn-sm">
                                                <i class="bi bi-play-circle"></i> Start OCR
                                            </button>
                                        </div>

                                        <label class="form-label fw-bold small mb-1">Configuration Preset</label>
                                        <div class="input-group input-group-sm mb-2">
                                            <select id="configSelect" onchange="handleConfigSelect()" class="form-select">
                                                <option value="-1">-- Custom Preset --</option>
                                            </select>
                                            <button onclick="resetToNewCustomConfig()" class="btn btn-info text-white" title="New / Reset">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                            <button onclick="handleSaveButton()" class="btn btn-primary" title="Save">
                                                <i class="bi bi-save"></i>
                                            </button>
                                            <button id="deleteConfigButton" onclick="deleteCurrentConfig()" class="btn btn-danger" disabled title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted" id="configNameDisplay" style="font-size: 0.75rem;">Current: Custom</small>
                                        </div>

                                        <!-- Scan Mode Toggle -->
                                        <div class="btn-group w-100 btn-group-sm mb-2" role="group">
                                            <input type="radio" class="btn-check" name="scanMode" id="modeSingle" value="uni" checked onchange="toggleScanMode()">
                                            <label class="btn btn-outline-secondary" for="modeSingle">Uni-Scan</label>

                                            <input type="radio" class="btn-check" name="scanMode" id="modeDual" value="dual" onchange="toggleScanMode()">
                                            <label class="btn btn-outline-secondary" for="modeDual">Dual Scan</label>
                                        </div>

                                        <button id="btnSelectRegion" class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="startRegionSelection()">
                                            <i class="bi bi-bounding-box-circles"></i> Drag & Select Region
                                        </button>

                                        <!-- Region 1 Controls -->
                                        <div class="row g-1 mb-2">
                                            <div class="col-12"><span class="badge bg-light text-dark border w-100 text-start">Region 1 (Top)</span></div>
                                            <div class="col-3">
                                                <input type="number" id="regionX" value="0" min="0" class="form-control form-control-sm" placeholder="X">
                                            </div>
                                            <div class="col-3">
                                                <input type="number" id="regionY" value="0" min="0" class="form-control form-control-sm" placeholder="Y">
                                            </div>
                                            <div class="col-3">
                                                <input type="number" id="regionW" value="300" min="10" class="form-control form-control-sm" placeholder="W">
                                            </div>
                                            <div class="col-3">
                                                <input type="number" id="regionH" value="50" min="10" class="form-control form-control-sm" placeholder="H">
                                            </div>
                                        </div>

                                        <!-- Region 2 Controls (Hidden by default) -->
                                        <div id="region2Controls" class="row g-1" style="display:none;">
                                            <div class="col-12"><span class="badge bg-light text-dark border w-100 text-start">Region 2 (Bottom)</span></div>
                                            <div class="col-3">
                                                <input type="number" id="region2X" value="0" min="0" class="form-control form-control-sm" placeholder="X">
                                            </div>
                                            <div class="col-3">
                                                <input type="number" id="region2Y" value="0" min="0" class="form-control form-control-sm" placeholder="Y">
                                            </div>
                                            <div class="col-3">
                                                <input type="number" id="region2W" value="300" min="10" class="form-control form-control-sm" placeholder="W">
                                            </div>
                                            <div class="col-3">
                                                <input type="number" id="region2H" value="50" min="10" class="form-control form-control-sm" placeholder="H">
                                            </div>
                                        </div>
                                    </div>

                                    <hr class="my-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <label class="form-label fw-bold small mb-1">Live Preview</label>
                                    </div>
                                    
                                    <div id="viewPanel" class="capture-canvas-container rounded flex-grow-1">
                                        <span id="viewPlaceholder" class="text-muted small">No source connected</span>
                                        
                                        <!-- Unified Preview Container -->
                                        <div id="rawCaptureContainer" style="display:none;" class="flex-column align-items-center w-100 position-relative">
                                            <!-- UPDATED: Width 100% to force zoom/stretch -->
                                            <canvas id="captureView" class="border shadow-sm" style="width: 60%; height: auto; display: block; image-rendering: pixelated;"></canvas>
                                            
                                            <!-- Overlay Badge for locked state -->
                                            <div id="zoomStatusOverlay" class="zoom-badge">
                                                <span id="zoom1Status">R1: 1x</span>
                                                <span id="zoom2Status" style="display:none;">R2: 1x</span>
                                            </div>
                                        </div>

                                        <!-- Hidden Logic Canvas for OCR (Processed) -->
                                        <canvas id="canvasElement" style="display:none;"></canvas> 
                                    </div>
                                    <video id="videoElement" autoplay muted playsinline style="display:none;"></video>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-column gap-2 h-100">
                        <div class="card shadow-sm min-h-0" style="height: 30%;">
                            <div class="card-header bg-body-tertiary fw-bold text-success py-2 small text-uppercase">
                                <i class="bi bi-activity"></i> Active Events
                            </div>
                            <div class="card-body p-0 overflow-auto d-flex flex-column">
                                <div id="activeEventsContainer" class="flex-grow-1 p-0">
                                    <!-- Dynamic Content will be injected here -->
                                    <div id="activeMoonsSection" class="d-none">
                                        <div class="px-2 py-1 small fw-bold text-primary bg-body-tertiary border-bottom border-top">Active Events - Moon</div>
                                        <div id="activeMoonsList" class="list-group list-group-flush small"></div>
                                    </div>
                                    
                                    <div id="activeWeatherSection" class="d-none">
                                        <div class="px-2 py-1 small fw-bold text-info-emphasis bg-body-tertiary border-bottom border-top">Active Events - Weather</div>
                                        <div id="activeWeatherList" class="list-group list-group-flush small"></div>
                                    </div>
                                    
                                    <div id="cooldownsPlaceholder" class="p-3 text-center text-muted small">
                                        No events currently active.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm flex-fill min-h-0">
                            <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center py-1">
                                <span class="fw-bold small">System Logs</span>
                                <button id="clearLogsButton" onclick="clearLogs()" class="btn btn-outline-secondary btn-sm py-0" style="font-size: 0.7rem;">Clear</button>
                            </div>
                            <div class="card-body p-0 d-flex flex-column h-100 overflow-hidden">
                                <div id="cooldownTimerLog" class="bg-warning text-dark px-2 py-1 small fw-bold" style="font-size: 0.7rem;">App Status: Idle</div>
                                <!-- UPDATED: scroll-y-auto ensures it scrolls and flex-grow ensures it fills height -->
                                <div id="logContent" class="console-log flex-grow-1 p-2 scroll-y-auto">
                                    Application initialized.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-column h-100">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-body-tertiary fw-bold d-flex justify-content-between align-items-center py-2 small text-uppercase">
                                <span><i class="bi bi-clock-history"></i> History</span>
                                <div class="d-flex gap-1">
                                    <button id="clearHistoryButton" class="btn btn-sm btn-outline-danger py-0 px-2" onclick="clearHistory()" title="Clear History">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button id="sortEventsButton" class="btn btn-sm btn-link text-decoration-none p-0" onclick="toggleEventSortOrder()" title="Toggle Sort">
                                        <span id="sortIcon"><i class="bi bi-sort-down"></i></span>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column p-2 gap-2 overflow-hidden">
                                <div class="row g-2 mb-2 flex-shrink-0">
                                    <div class="col-5">
                                        <input type="date" id="eventDatePicker" class="form-control form-control-sm" style="font-size: 0.8rem;" onchange="updateSearchDatalist(); renderRecentEvents()">
                                    </div>
                                    <div class="col-7">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text py-0"><i class="bi bi-search"></i></span>
                                            <input type="text" id="eventSearchInput" list="eventNamesList" oninput="renderRecentEvents()" class="form-control" placeholder="Search..." style="font-size: 0.8rem;">
                                            <datalist id="eventNamesList"></datalist>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mb-1 flex-shrink-0">
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <input type="radio" class="btn-check" name="typeFilter" id="typeAll" value="All" checked onchange="updateSearchDatalist(); renderRecentEvents()">
                                        <label class="btn btn-outline-secondary" for="typeAll">All</label>

                                        <input type="radio" class="btn-check" name="typeFilter" id="typeMoon" value="Moon" onchange="updateSearchDatalist(); renderRecentEvents()">
                                        <label class="btn btn-outline-secondary" for="typeMoon">Moons</label>

                                        <input type="radio" class="btn-check" name="typeFilter" id="typeWeather" value="Weather" onchange="updateSearchDatalist(); renderRecentEvents()">
                                        <label class="btn btn-outline-secondary" for="typeWeather">Weather</label>
                                    </div>
                                </div>

                                <!-- UPDATED: scroll-y-auto for internal scrolling -->
                                <div id="recentEventsList" class="flex-grow-1 scroll-y-auto border rounded bg-body-tertiary p-0">
                                    <p class="text-center text-muted small mt-2">Select a date.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="moonWeatherTab" class="tab-content-wrapper">
                <div class="moon-tab-grid">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-body-tertiary fw-bold d-flex justify-content-between align-items-center py-2">
                            <span><i class="bi bi-card-list"></i> Event Management</span>
                            <div class="d-flex gap-2">
                                <button onclick="showItemModal(-1)" class="btn btn-sm btn-primary py-0"><i class="bi bi-plus-circle"></i> Add</button>
                            </div>
                        </div>
                        
                        <div class="card-body d-flex flex-column h-100 overflow-hidden gap-2 p-2">
                            
                            <div id="listSplitWrapper" class="list-split-wrapper flex-column flex-lg-row">
                                
                                <div class="list-section">
                                    <div class="list-section-header bg-body-tertiary px-2 py-1 small fw-bold border-bottom text-primary sticky-top"><i class="bi bi-moon-stars"></i> Moons</div>
                                    <div id="moonListContainer" class="list-scroll-area">
                                        <p class="text-muted small text-center p-3">No moons added.</p>
                                    </div>
                                </div>

                                <div class="list-section">
                                    <div class="list-section-header bg-body-tertiary px-2 py-1 small fw-bold border-bottom text-info-emphasis sticky-top"><i class="bi bi-cloud-haze"></i> Weathers</div>
                                    <div id="weatherListContainer" class="list-scroll-area">
                                        <p class="text-muted small text-center p-3">No weather added.</p>
                                    </div>
                                </div>

                            </div>
                            
                            <div class="card bg-body-tertiary border-0 flex-shrink-0 mt-auto">
                                <div class="card-body p-2">
                                    <label class="form-label small fw-bold mb-1" style="font-size: 0.75rem;">Data Management</label>
                                    <div class="d-flex gap-2">
                                        <div class="input-group input-group-sm flex-grow-1">
                                            <input type="file" id="fileUpload" accept=".csv" class="form-control" onchange="updateUploadLabel(this)">
                                            <label class="input-group-text" for="fileUpload"><i class="bi bi-upload"></i> Import</label>
                                        </div>
                                        <button onclick="exportEvents()" class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-download"></i> Export
                                        </button>
                                    </div>
                                    <div class="form-text small mt-1" style="font-size: 0.7rem;">Required: Name, Type, Multiplier, Chances</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-body-tertiary fw-bold py-2">
                            <i class="bi bi-bar-chart-line"></i> Statistics
                        </div>
                        <div class="card-body d-flex flex-column p-2 overflow-hidden">
                            <div class="row g-2 mb-2">
                                <div class="col-12">
                                    <label class="form-label small mb-0" style="font-size: 0.75rem;">Date Range</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text py-0" style="font-size: 0.75rem;">From</span>
                                        <input type="date" id="statsDateStart" class="form-control form-control-sm" 
                                            onchange="if(this.value > document.getElementById('statsDateEnd').value) { showToast('Start date cannot be after End date.', 'error'); this.value = document.getElementById('statsDateEnd').value; } updateItemListDropdown();" 
                                            style="font-size: 0.8rem;">
                                        <span class="input-group-text py-0" style="font-size: 0.75rem;">To</span>
                                        <input type="date" id="statsDateEnd" class="form-control form-control-sm" 
                                            onchange="if(this.value < document.getElementById('statsDateStart').value) { showToast('End date cannot be before Start date.', 'error'); this.value = document.getElementById('statsDateStart').value; } updateItemListDropdown();" 
                                            style="font-size: 0.8rem;">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small mb-0" style="font-size: 0.75rem;">Metric</label>
                                    <select id="statsMetricFilter" onchange="updateEventStatistics()" class="form-select form-select-sm" style="font-size: 0.8rem;">
                                        <option value="count">Occurrences</option>
                                        <option value="avgTime">Avg Time</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small mb-0" style="font-size: 0.75rem;">Event</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text py-0"><i class="bi bi-search"></i></span>
                                        <input type="text" id="statsItemFilter" list="statsItemDataList" oninput="updateEventStatistics()" class="form-control" placeholder="Search or Select..." style="font-size: 0.8rem;">
                                        <datalist id="statsItemDataList"></datalist>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small mb-0" style="font-size: 0.75rem;">Type</label>
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <input type="radio" class="btn-check" name="statsTypeFilter" id="statsTypeAll" value="All" checked onchange="updateItemListDropdown()">
                                        <label class="btn btn-outline-secondary" for="statsTypeAll">All</label>

                                        <input type="radio" class="btn-check" name="statsTypeFilter" id="statsTypeMoon" value="Moon" onchange="updateItemListDropdown()">
                                        <label class="btn btn-outline-secondary" for="statsTypeMoon">Moons</label>

                                        <input type="radio" class="btn-check" name="statsTypeFilter" id="statsTypeWeather" value="Weather" onchange="updateItemListDropdown()">
                                        <label class="btn btn-outline-secondary" for="statsTypeWeather">Weather</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-none">
                                <span id="avgDurationDisplay"></span>
                            </div>

                            <div class="flex-grow-1 position-relative border rounded p-1 min-h-0">
                                <canvas id="eventStatsChart"></canvas>
                                <div id="chartPlaceholder" class="position-absolute top-50 start-50 translate-middle text-muted small">
                                    No Data
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content-wrapper">
                <div class="container-fluid p-0 pb-4" style="max-width: 800px;">
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-body-tertiary fw-bold text-primary">
                            <i class="bi bi-discord"></i> Discord Webhooks
                        </div>
                        <div class="card-body">
                            <div id="webhookListContainer" class="d-flex flex-column gap-2 mb-3">
                                <p class="text-muted small text-center">No webhooks configured.</p>
                            </div>
                            <button onclick="showWebhookModal(-1)" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-plus-lg"></i> Add Webhook
                            </button>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-body-tertiary fw-bold">
                            <i class="bi bi-stopwatch"></i> Timing
                        </div>
                        <div class="card-body">
                            <label for="gracePeriodSeconds" class="form-label fw-bold">Event Disappear Grace Period (Seconds)</label>
                            <input type="number" id="gracePeriodSeconds" value="5" min="1" max="60" step="1" class="form-control w-50">
                            <div class="form-text">Time to wait after text disappears before ending the event.</div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-danger">
                        <div class="card-body">
                            <h5 class="card-title text-danger"><i class="bi bi-exclamation-octagon"></i> Application Reset</h5>
                            <p class="card-text small text-muted">This action will wipe all local storage data and reset the app.</p>
                            <button onclick="removeSettings()" class="btn btn-danger btn-sm">
                                <i class="bi bi-trash"></i> Clear All Saved Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="aboutTab" class="tab-content-wrapper">
                <div class="container-fluid p-0 pb-4" style="max-width: 800px;">
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-body-tertiary fw-bold text-info-emphasis">
                            <i class="bi bi-info-circle"></i> About This Tool
                        </div>
                        <div class="card-body">
                            <p class="lead fs-6">
                                This automated tool is created for the Roblox game: <strong>Feed Your Pet</strong>. 
                                It is designed to automate the sending of notifications to Discord when specific Events (Moons/Weathers) are detected on screen.
                            </p>
                            <hr>
                            <h6 class="fw-bold">How it Works</h6>
                            <ul class="list-group list-group-flush small">
                                <li class="list-group-item border-0 ps-0"><i class="bi bi-camera-video text-primary me-2"></i> <strong>Screen Capture:</strong> The tool captures a specific region of your screen where event text appears.</li>
                                <li class="list-group-item border-0 ps-0"><i class="bi bi-eye text-success me-2"></i> <strong>OCR Detection:</strong> It uses optical character recognition to read text from the video stream in real-time.</li>
                                <li class="list-group-item border-0 ps-0"><i class="bi bi-robot text-warning me-2"></i> <strong>Event Matching:</strong> It compares detected text against your custom list of events.</li>
                                <li class="list-group-item border-0 ps-0"><i class="bi bi-discord text-info me-2"></i> <strong>Discord Alert:</strong> When a match occurs, it instantly sends a notification to your configured Discord Webhooks.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 bg-transparent">
                        <div class="card-body text-center text-muted">
                            <div class="mb-3">
                                <small class="text-uppercase fw-bold" style="letter-spacing: 1px;">Created By</small>
                                <div class="mt-1">
                                    <span class="badge bg-dark p-2"><i class="bi bi-discord"></i> BlackBox (@rlobrin)</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-uppercase fw-bold" style="letter-spacing: 1px;">Supported By</small>
                                <div class="mt-1">
                                    <span class="badge bg-secondary p-2"><i class="bi bi-discord"></i> Gunnster247 (@gunnster247)</span>
                                </div>
                            </div>

                            <div>
                                <small class="text-uppercase fw-bold" style="letter-spacing: 1px;">Special Thanks</small>
                                <div class="mt-1 d-flex justify-content-center flex-wrap gap-2">
                                    <span class="badge bg-body-tertiary text-body border">Queen Branana (@queen_branana)</span>
                                </div>
                                <div class="mt-2 small text-muted">
                                    And all members of <br>
                                    <a href="https://discord.gg/aE7e6SnB" target="_blank" class="text-decoration-none fw-bold">FYP-TBND</a> & 
                                    <a href="https://discord.gg/YFy8s5E5" target="_blank" class="text-decoration-none fw-bold">RMTG</a>
                                </div>
                            </div>
                            
                            <div class="mt-4 border-top pt-3 small text-muted">
                                &copy; <span id="currentYear"></span> All Rights Reserved.
                            </div>
                            <script>document.getElementById('currentYear').textContent = new Date().getFullYear();</script>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="itemWebhookModal" class="custom-modal-overlay">
        <div class="custom-modal-dialog">
            <div class="custom-modal-header"><h5 class="modal-title fw-bold">Manage Notifications</h5><button type="button" class="btn-close" onclick="hideItemWebhookModal()"></button></div>
            <div class="custom-modal-body d-flex flex-column h-100">
                <p class="small text-muted mb-2" id="webhookModalItemName">Select webhooks:</p>
                <div id="itemWebhookListContainer" class="flex-grow-1 overflow-auto border rounded bg-body-tertiary p-2" style="max-height: 400px;"></div>
            </div>
            <div class="modal-footer p-2 border-top bg-body-tertiary"><button type="button" class="btn btn-primary w-100" onclick="saveItemWebhooks()">Save Changes</button></div>
        </div>
    </div>

    <div id="webhookEventsModal" class="custom-modal-overlay">
        <div class="custom-modal-dialog">
            <div class="custom-modal-header"><h5 class="modal-title fw-bold">Select Events</h5><button type="button" class="btn-close" onclick="hideWebhookEventsModal()"></button></div>
            <div class="custom-modal-body d-flex flex-column h-100">
                <p class="small text-muted mb-2" id="webhookEventsModalTitle">Select events:</p>
                <div class="d-flex gap-2 mb-3">
                    <div class="input-group input-group-sm flex-grow-1">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="webhookEventsSearchInput" placeholder="Filter events..." oninput="filterWebhookEventsSelection()">
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleSelectAllEventsForWebhook(true)">All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleSelectAllEventsForWebhook(false)">None</button>
                </div>
                <div id="webhookEventsListContainer" class="flex-grow-1 overflow-auto border rounded bg-body-tertiary p-2" style="max-height: 400px;"></div>
            </div>
            <div class="modal-footer p-2 border-top bg-body-tertiary"><button type="button" class="btn btn-primary w-100" onclick="saveWebhookEvents()">Save Changes</button></div>
        </div>
    </div>

    <div id="webhookModal" class="custom-modal-overlay">
        <div class="custom-modal-dialog custom-modal-lg">
            <div class="custom-modal-header"><h5 class="modal-title fw-bold" id="webhookModalTitle">Add Webhook</h5><button type="button" class="btn-close" onclick="hideWebhookModal()"></button></div>
            <div class="custom-modal-body">
                <form id="webhookForm">
                    <input type="hidden" id="webhookIndex" value="-1">
                    <div class="mb-3"><label class="form-label fw-bold small">Description</label><input type="text" id="modalWebhookDescription" class="form-control" required placeholder="e.g. Main Channel"></div>
                    <div class="mb-3"><label class="form-label fw-bold small">Webhook URL</label><div class="input-group"><input type="text" id="modalWebhookUrl" class="form-control" required placeholder="e.g. https://discord.com/api/webhooks/..."><button class="btn btn-outline-info" type="button" onclick="testNewWebhook()">Test</button></div></div>
                    <button type="submit" class="btn btn-primary w-100">Save Webhook</button>
                </form>
            </div>
        </div>
    </div>

    <div id="itemModal" class="custom-modal-overlay">
        <div class="custom-modal-dialog custom-modal-lg">
            <div class="custom-modal-header"><h5 class="modal-title fw-bold" id="modalTitle">Add Event</h5><button type="button" class="btn-close" onclick="hideItemModal()"></button></div>
            <div class="custom-modal-body">
                <div class="row g-3">
                    <div class="col-md-6 border-end">
                        <form id="itemForm">
                            <input type="hidden" id="itemIndex" value="-1">
                            <div class="mb-3"><label class="form-label fw-bold small">Name</label><input type="text" id="itemName" class="form-control" required placeholder="e.g. Blue Moon"></div>
                            <div class="mb-3"><label class="form-label fw-bold small">Type</label><select id="itemType" class="form-select"><option value="Moon">Moon</option><option value="Weather">Weather</option></select></div>
                            <div class="mb-3"><label class="form-label fw-bold small">Multiplier</label><input type="number" step="0.01" id="itemMultiplier" value="3" class="form-control" required placeholder="e.g. 3.5"></div>
                            <div class="mb-3"><label class="form-label fw-bold small">Chances</label><input type="text" id="itemChances" class="form-control" placeholder="e.g. 1/1000"></div>
                            <button type="submit" id="formSubmitButton" class="btn btn-primary w-100">Save</button>
                        </form>
                    </div>
                    <div class="col-md-6 d-flex flex-column" style="height: 100%; min-height: 350px;">
                        <h6 class="fw-bold small mb-2">Existing Events</h6>
                        <div class="d-flex flex-column gap-2 flex-grow-1 min-h-0">
                            <div class="border rounded d-flex flex-column" style="flex: 1; min-height: 0;"><div class="bg-body-tertiary px-2 py-1 small fw-bold border-bottom text-primary sticky-top">Moons</div><div id="modalMoonPreview" class="overflow-auto flex-grow-1"></div></div>
                            <div class="border rounded d-flex flex-column" style="flex: 1; min-height: 0;"><div class="bg-body-tertiary px-2 py-1 small fw-bold border-bottom text-info-emphasis sticky-top">Weathers</div><div id="modalWeatherPreview" class="overflow-auto flex-grow-1"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="configModal" class="custom-modal-overlay">
        <div class="custom-modal-dialog" style="max-width: 400px;">
            <div class="custom-modal-header"><h5 class="modal-title fw-bold" id="configModalTitle">Save Config</h5><button type="button" class="btn-close" onclick="hideConfigModal()"></button></div>
            <div class="custom-modal-body">
                <form id="saveConfigForm">
                    <div class="mb-3"><label class="form-label fw-bold small">Preset Name</label><input type="text" id="configName" class="form-control" required></div>
                    <button type="submit" class="btn btn-primary w-100">Save Preset</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Region Selection Modal -->
    <div id="regionSelectionModal" class="custom-modal-overlay" style="z-index: 2000;">
        <div class="d-flex flex-column align-items-center justify-content-center w-100 h-100 p-4">
            <div class="bg-dark rounded p-2 d-flex flex-column gap-2" style="max-width: 95vw; max-height: 90vh;">
                <div class="d-flex justify-content-between align-items-center text-white px-2">
                    <span id="regionSelectionTitle"><i class="bi bi-mouse"></i> Drag to select area</span>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="confirmRegionSelection()"><i class="bi bi-check-lg"></i> Confirm</button>
                        <button class="btn btn-sm btn-secondary" onclick="closeRegionSelection()"><i class="bi bi-x-lg"></i> Cancel</button>
                    </div>
                </div>
                <div id="selectionCanvasContainer" style="position: relative; overflow: hidden; background: #000; border: 1px solid #444;">
                    <canvas id="selectionCanvas" style="cursor: crosshair; display: block; max-width: 100%; max-height: 80vh; object-fit: contain;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        const logContentDiv = document.getElementById('logContent');
        const cooldownsPlaceholder = document.getElementById('cooldownsPlaceholder');
        const activeMoonsList = document.getElementById('activeMoonsList');
        const activeWeatherList = document.getElementById('activeWeatherList');
        const activeMoonsSection = document.getElementById('activeMoonsSection');
        const activeWeatherSection = document.getElementById('activeWeatherSection');
        const cooldownTimerLog = document.getElementById('cooldownTimerLog');
        const rawCaptureContainer = document.getElementById('rawCaptureContainer');
        const viewPlaceholder = document.getElementById('viewPlaceholder');
        
        // --- Input Elements ---
        const regionXInput = document.getElementById('regionX');
        const regionYInput = document.getElementById('regionY');
        const regionWInput = document.getElementById('regionW');
        const regionHInput = document.getElementById('regionH');
        // Region 2 Inputs
        const region2XInput = document.getElementById('region2X');
        const region2YInput = document.getElementById('region2Y');
        const region2WInput = document.getElementById('region2W');
        const region2HInput = document.getElementById('region2H');
        const region2Controls = document.getElementById('region2Controls');

        const captureViewCanvas = document.getElementById('captureView');
        const videoElement = document.getElementById('videoElement');
        const processButton = document.getElementById('processButton');
        const connectScreenButton = document.getElementById('connectScreenButton');
        const canvasElement = document.getElementById('canvasElement');
        const gracePeriodSecondsInput = document.getElementById('gracePeriodSeconds');
        
        // --- State Variables ---
        let moonWeatherList = [];
        let webhookList = [];
        let ocrConfigs = [];
        let currentConfigIndex = -1; 
        let configIsDirty = false; 
        let activeItems = {}; 
        let ocrScanInterval = null;
        let previewInterval = null;
        let activeStatusInterval = null;
        let eventSortOrder = 'desc'; 
        let localStream = null;
        let isOcrBusy = false; // Prevents overlapping Tesseract calls

        // --- DUAL SMART ZOOM VARIABLES ---
        let scanMode = 'uni'; // 'uni' or 'dual'
        let zoom1 = 2; 
        let lock1 = false;
        let zoom2 = 2;
        let lock2 = false;
        let dragSelectionStep = 0; // 0=None, 1=Region1, 2=Region2
        
        // --- Webhook & Modal State ---
        let currentEditingWebhookIndex = -1;
        const webhookEventsModal = document.getElementById('webhookEventsModal');
        const webhookEventsListContainer = document.getElementById('webhookEventsListContainer');
        const webhookEventsSearchInput = document.getElementById('webhookEventsSearchInput');
        const webhookEventsModalTitle = document.getElementById('webhookEventsModalTitle');

        // --- Chart Variables ---
        let eventStatsChartInstance = null;

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadSettings();
        });
        
        // --- Theme Management ---
        function setTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            const btnIcon = document.getElementById('themeIcon');
            if(theme === 'dark') {
                btnIcon.classList.remove('bi-sun-fill');
                btnIcon.classList.add('bi-moon-stars-fill');
            } else {
                btnIcon.classList.remove('bi-moon-stars-fill');
                btnIcon.classList.add('bi-sun-fill');
            }
        }
        function toggleTheme() {
            const current = localStorage.getItem('theme') || 'light';
            setTheme(current === 'light' ? 'dark' : 'light');
        }
        function loadTheme() { setTheme(localStorage.getItem('theme') || 'light'); }

        // --- Settings & Config ---
        function loadSettings() {
            try {
                webhookList = JSON.parse(localStorage.getItem('webhookList')) || [];
                moonWeatherList = JSON.parse(localStorage.getItem('moonWeatherList')) || [];
                ocrConfigs = JSON.parse(localStorage.getItem('ocrConfigs')) || [];
                
                // Region 1 Load
                regionXInput.value = localStorage.getItem('regionX') || '0';
                regionYInput.value = localStorage.getItem('regionY') || '0';
                regionWInput.value = localStorage.getItem('regionW') || '300';
                regionHInput.value = localStorage.getItem('regionH') || '50';
                
                // Region 2 Load
                region2XInput.value = localStorage.getItem('region2X') || '0';
                region2YInput.value = localStorage.getItem('region2Y') || '0';
                region2WInput.value = localStorage.getItem('region2W') || '300';
                region2HInput.value = localStorage.getItem('region2H') || '50';
                
                scanMode = localStorage.getItem('scanMode') || 'uni';
                if(document.getElementById('modeSingle')) {
                    document.getElementById('modeSingle').checked = (scanMode === 'uni');
                    document.getElementById('modeDual').checked = (scanMode === 'dual');
                }
                toggleScanMode(false); // Apply UI state without saving immediately

                currentConfigIndex = parseInt(localStorage.getItem('currentConfigIndex') || '-1');
                gracePeriodSecondsInput.value = localStorage.getItem('gracePeriodSeconds') || '5';
                
                // Initialize Dates (Using Local Time)
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                if(document.getElementById('eventDatePicker')) document.getElementById('eventDatePicker').value = today;
                if(document.getElementById('statsDateStart')) document.getElementById('statsDateStart').value = today;
                if(document.getElementById('statsDateEnd')) document.getElementById('statsDateEnd').value = today;

                renderList();
                renderWebhookList();
                updateConfigDropdown();
                updateSearchDatalist();
                renderRecentEvents();
                try { updateItemListDropdown(); } catch(e) {}
                
                if (!activeStatusInterval) activeStatusInterval = setInterval(renderActiveStatus, 500);
                
                addLog("System initialized.");
                refreshTooltips();
            } catch (e) { console.error(e); }
        }

        function saveSettings() {
            localStorage.setItem('moonWeatherList', JSON.stringify(moonWeatherList));
            localStorage.setItem('webhookList', JSON.stringify(webhookList));
            localStorage.setItem('ocrConfigs', JSON.stringify(ocrConfigs));
            localStorage.setItem('currentConfigIndex', currentConfigIndex);
            
            localStorage.setItem('regionX', regionXInput.value);
            localStorage.setItem('regionY', regionYInput.value);
            localStorage.setItem('regionW', regionWInput.value);
            localStorage.setItem('regionH', regionHInput.value);
            
            localStorage.setItem('region2X', region2XInput.value);
            localStorage.setItem('region2Y', region2YInput.value);
            localStorage.setItem('region2W', region2WInput.value);
            localStorage.setItem('region2H', region2HInput.value);
            
            localStorage.setItem('scanMode', scanMode);
            localStorage.setItem('gracePeriodSeconds', gracePeriodSecondsInput.value);
        }

        function removeSettings() {
            if (confirm("Reset ALL settings?")) { localStorage.clear(); location.reload(); }
        }

        // --- Mode Toggling ---
        function toggleScanMode(save = true) {
            const mode = document.querySelector('input[name="scanMode"]:checked').value;
            scanMode = mode;
            if (mode === 'dual') {
                region2Controls.style.display = 'flex';
                document.getElementById('zoom2Status').style.display = 'block';
                document.title = "FYP Notifier (Dual Scan)";
            } else {
                region2Controls.style.display = 'none';
                document.getElementById('zoom2Status').style.display = 'none';
                document.title = "FYP Notifier (Uni-Scan)";
            }
            if(save) {
                saveSettings();
                updatePreviewAndSize();
            }
        }

        // --- Config Management ---
        function updateConfigDropdown() {
            const select = document.getElementById('configSelect');
            select.innerHTML = '<option value="-1">-- Custom Preset --</option>';
            ocrConfigs.forEach((c, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = c.name;
                select.appendChild(opt);
            });
            select.value = currentConfigIndex;
            document.getElementById('deleteConfigButton').disabled = (currentConfigIndex === -1);
            
            const display = document.getElementById('configNameDisplay');
            display.textContent = currentConfigIndex === -1 ? "Current: Custom" : `Current: ${ocrConfigs[currentConfigIndex].name}`;
        }

        function handleConfigSelect() {
            const idx = parseInt(document.getElementById('configSelect').value);
            currentConfigIndex = idx;
            if (idx !== -1 && ocrConfigs[idx]) {
                const c = ocrConfigs[idx];
                regionXInput.value = c.x; regionYInput.value = c.y; regionWInput.value = c.w; regionHInput.value = c.h;
                region2XInput.value = c.r2x || 0; region2YInput.value = c.r2y || 0; region2WInput.value = c.r2w || 300; region2HInput.value = c.r2h || 50;
                scanMode = c.mode || 'uni';
                
                document.getElementById('modeSingle').checked = (scanMode === 'uni');
                document.getElementById('modeDual').checked = (scanMode === 'dual');
                toggleScanMode(false);
                
                showToast(`Loaded "${c.name}"`);
                saveSettings(); updatePreviewAndSize();
            }
            updateConfigDropdown();
        }

        function handleSaveButton() {
            if (currentConfigIndex !== -1) {
                const c = ocrConfigs[currentConfigIndex];
                c.x = parseInt(regionXInput.value); c.y = parseInt(regionYInput.value); c.w = parseInt(regionWInput.value); c.h = parseInt(regionHInput.value);
                c.r2x = parseInt(region2XInput.value); c.r2y = parseInt(region2YInput.value); c.r2w = parseInt(region2WInput.value); c.r2h = parseInt(region2HInput.value);
                c.mode = scanMode;
                saveSettings(); showToast(`Updated "${c.name}"`);
            } else {
                document.getElementById('configModal').style.display = 'flex';
                document.getElementById('configName').focus();
            }
        }

        document.getElementById('saveConfigForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('configName').value.trim();
            if(!name) return;
            const newC = {
                name, 
                x: parseInt(regionXInput.value), y: parseInt(regionYInput.value), w: parseInt(regionWInput.value), h: parseInt(regionHInput.value),
                r2x: parseInt(region2XInput.value), r2y: parseInt(region2YInput.value), r2w: parseInt(region2WInput.value), r2h: parseInt(region2HInput.value),
                mode: scanMode
            };
            ocrConfigs.push(newC);
            currentConfigIndex = ocrConfigs.length - 1;
            saveSettings(); updateConfigDropdown();
            document.getElementById('configModal').style.display = 'none';
            showToast(`Preset "${name}" saved.`);
        });

        function deleteCurrentConfig() {
            if(currentConfigIndex !== -1 && confirm("Delete preset?")) {
                const name = ocrConfigs[currentConfigIndex].name;
                ocrConfigs.splice(currentConfigIndex, 1);
                currentConfigIndex = -1;
                saveSettings(); updateConfigDropdown();
                showToast(`Preset "${name}" deleted.`);
            }
        }

        function resetToNewCustomConfig() {
            currentConfigIndex = -1;
            scanMode = 'uni';
            document.getElementById('modeSingle').checked = true;
            toggleScanMode();
            regionXInput.value = 0; regionYInput.value = 0; regionWInput.value = 300; regionHInput.value = 50;
            updateConfigDropdown(); saveSettings(); updatePreviewAndSize();
            showToast("Reset to defaults.");
        }
        
        // --- Screen Capture ---
        async function connectScreen() {
            if (localStream && localStream.active) { stopStream(); return; }
            if (!navigator.mediaDevices) return;
            
            connectScreenButton.disabled = true;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: false });
                localStream = stream;
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    connectScreenButton.innerHTML = '<i class="bi bi-display"></i> Connected (Stop)';
                    connectScreenButton.classList.replace('btn-primary', 'btn-outline-primary');
                    connectScreenButton.disabled = false;
                    processButton.disabled = false;
                    
                    if(previewInterval) clearInterval(previewInterval);
                    previewInterval = setInterval(drawLivePreview, 100);
                    
                    rawCaptureContainer.style.display = 'flex';
                    viewPlaceholder.style.display = 'none';
                    addLog("Screen connected.");
                    showToast("Screen Source Connected.");
                };
                stream.getVideoTracks()[0].onended = stopStream;
            } catch (err) {
                console.error(err);
                connectScreenButton.disabled = false;
            }
        }

        function stopStream() {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            localStream = null;
            videoElement.srcObject = null;
            if(ocrScanInterval) toggleProcess(true);
            connectScreenButton.innerHTML = '<i class="bi bi-display"></i> Connect';
            connectScreenButton.classList.replace('btn-outline-primary', 'btn-primary');
            connectScreenButton.disabled = false;
            processButton.disabled = true;
            rawCaptureContainer.style.display = 'none';
            viewPlaceholder.style.display = 'block';
            if(previewInterval) clearInterval(previewInterval);
            addLog("Screen Disconnected.");
            showToast("Screen Source Disconnected.");
        }

        // --- Live Preview & Canvas Logic ---
        function drawLivePreview() {
            if (videoElement.readyState < videoElement.HAVE_ENOUGH_DATA) return;
            
            const r1 = { x: parseInt(regionXInput.value)||0, y: parseInt(regionYInput.value)||0, w: parseInt(regionWInput.value)||300, h: parseInt(regionHInput.value)||50 };
            
            if (scanMode === 'dual') {
                const r2 = { x: parseInt(region2XInput.value)||0, y: parseInt(region2YInput.value)||0, w: parseInt(region2WInput.value)||300, h: parseInt(region2HInput.value)||50 };
                
                // Set canvas size to stack them. Width is max of both. Height is sum + padding.
                const maxWidth = Math.max(r1.w, r2.w);
                const totalHeight = r1.h + r2.h + 2; // 2px gap
                
                captureViewCanvas.width = maxWidth;
                captureViewCanvas.height = totalHeight;
                
                const ctx = captureViewCanvas.getContext('2d');
                // Fill bg
                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, maxWidth, totalHeight);
                
                // Draw R1
                ctx.drawImage(videoElement, r1.x, r1.y, r1.w, r1.h, 0, 0, r1.w, r1.h);
                // Draw separator line
                ctx.fillStyle = '#0dcaf0'; // Cyan line
                ctx.fillRect(0, r1.h, maxWidth, 2);
                // Draw R2
                ctx.drawImage(videoElement, r2.x, r2.y, r2.w, r2.h, 0, r1.h + 2, r2.w, r2.h);
                
            } else {
                captureViewCanvas.width = r1.w;
                captureViewCanvas.height = r1.h;
                captureViewCanvas.getContext('2d').drawImage(videoElement, r1.x, r1.y, r1.w, r1.h, 0, 0, r1.w, r1.h);
            }
        }
        
        function updatePreviewAndSize() { drawLivePreview(); }

        // --- OCR Logic ---
        let worker = null;
        
        function toggleProcess(forceStop = false) {
            if (ocrScanInterval) {
                // STOP
                const activeKeys = Object.keys(activeItems);
                if (!forceStop && activeKeys.length > 0) {
                    if (!confirm(` ${activeKeys.length} event(s) are currently active.\n\nStopping will mark them as ENDED and send final notifications.\n\nContinue?`)) return;
                }
                
                // Process ending for active items
                activeKeys.forEach(key => {
                    const state = activeItems[key];
                    if (state) {
                        if (state.timeout) clearTimeout(state.timeout);
                        const duration = Date.now() - state.start;
                        addLog(`**[STOPPED]** ${state.item.name} ended (OCR Stopped).`);
                        addRecentEvent(state.item, duration, state.start);
                        sendDiscordNotification(state.item, "end", duration);
                    }
                });

                clearInterval(ocrScanInterval); 
                ocrScanInterval = null;
                activeItems = {}; 
                renderActiveStatus();
                
                processButton.innerHTML = '<i class="bi bi-play-circle"></i> Start OCR';
                processButton.classList.replace('btn-danger', 'btn-success');
                addLog("OCR stopped.");
                showToast("OCR Stopped.");
                
                document.getElementById('zoom1Status').textContent = "R1: Idle";
                document.getElementById('zoom2Status').textContent = "R2: Idle";
            } else {
                // START
                const activeWebhooks = webhookList.filter(w => w.active);
                
                if (activeWebhooks.length === 0) { 
                    showToast("No active webhooks selected!", "error"); 
                    return; 
                }

                const hasLinkedEvents = moonWeatherList.some(item => 
                    item.webhookIds && item.webhookIds.some(id => activeWebhooks.find(aw => aw.id === id))
                );

                if (moonWeatherList.length === 0) {
                     alert(" No events configured.\n\nYou must add at least one event to proceed.");
                     return;
                } else if (!hasLinkedEvents) {
                     alert(" Active webhooks found, but no events are subscribed to them.\n\nYou must subscribe at least one event to a webhook to proceed.");
                     return;
                }
                
                // Reset State
                lock1 = false; zoom1 = 2;
                lock2 = false; zoom2 = 2;
                isOcrBusy = false;
                
                processButton.innerHTML = '<i class="bi bi-stop-circle"></i> Stop OCR';
                processButton.classList.replace('btn-success', 'btn-danger');
                addLog("OCR started.");
                showToast("OCR Started.");
                
                // Fast interval for smart zoom cycling (250ms)
                ocrScanInterval = setInterval(scanCameraImage, 250); 
                activeMoonsList.innerHTML = ''; 
                activeWeatherList.innerHTML = '';
                cooldownsPlaceholder.style.display = 'block';
                activeMoonsSection.classList.add('d-none');
                activeWeatherSection.classList.add('d-none');
            }
        }

        function scanCameraImage() {
            if (videoElement.readyState < videoElement.HAVE_ENOUGH_DATA || !ocrScanInterval || isOcrBusy) return;
            isOcrBusy = true;

            const r1 = { x: parseInt(regionXInput.value)||0, y: parseInt(regionYInput.value)||0, w: parseInt(regionWInput.value)||300, h: parseInt(regionHInput.value)||50 };
            
            // 1. Prepare Logic Canvas (Stitched + Zoomed)
            const ctx = canvasElement.getContext('2d');
            let boundaryY = 0; // Where R1 ends in the stitched image

            if (scanMode === 'dual') {
                const r2 = { x: parseInt(region2XInput.value)||0, y: parseInt(region2YInput.value)||0, w: parseInt(region2WInput.value)||300, h: parseInt(region2HInput.value)||50 };
                
                // Canvas width is max of both zoomed regions
                const w1 = r1.w * zoom1;
                const h1 = r1.h * zoom1;
                const w2 = r2.w * zoom2;
                const h2 = r2.h * zoom2;
                
                const finalW = Math.max(w1, w2);
                const finalH = h1 + h2; 
                
                canvasElement.width = finalW;
                canvasElement.height = finalH;
                
                // Draw R1 Zoomed
                ctx.drawImage(videoElement, r1.x, r1.y, r1.w, r1.h, 0, 0, w1, h1);
                // Draw R2 Zoomed below
                ctx.drawImage(videoElement, r2.x, r2.y, r2.w, r2.h, 0, h1, w2, h2);
                
                boundaryY = h1; // Anything below this Y is Region 2
                
                applyImagePreprocessing(ctx, finalW, finalH);
            } else {
                canvasElement.width = r1.w * zoom1;
                canvasElement.height = r1.h * zoom1;
                ctx.drawImage(videoElement, r1.x, r1.y, r1.w, r1.h, 0, 0, r1.w * zoom1, r1.h * zoom1);
                applyImagePreprocessing(ctx, r1.w * zoom1, r1.h * zoom1);
                boundaryY = canvasElement.height; // All is R1
            }
            
            // 2. Initialize Worker if needed
            if (!worker) worker = Tesseract.createWorker({ logger: () => {} });

            // 3. Run OCR
            new Promise(resolve => {
                worker.load().then(() => worker.loadLanguage('eng')).then(() => worker.initialize('eng')).then(() => {
                    worker.setParameters({ tessedit_pageseg_mode: 7 }); // Single line mode (or sparse text)
                    worker.recognize(canvasElement).then(resolve);
                });
            }).then(({ data }) => {
                if (!ocrScanInterval) { isOcrBusy = false; return; }
                
                let foundR1 = false;
                let foundR2 = false;

                // --- Detection Logic with Spatial Awareness ---
                // We iterate through detected words to see where they lie
                const words = data.words || [];
                const fullText = data.text.trim();

                // If no words but text exists, treat as generic match (fallback)
                // But better to check bounding boxes
                
                const currentMatches = new Map(); // Name -> {item, region}

                words.forEach(w => {
                    const txt = w.text.toLowerCase();
                    const y = w.bbox.y0;
                    const region = (scanMode === 'dual' && y >= boundaryY) ? 2 : 1;
                    
                    // Check against list
                    moonWeatherList.forEach(item => {
                        // Simple check: if word is part of item name
                        // Note: This is a bit weak for multi-word events like "Blue Moon" if split across lines
                        // Better: Check if the *Line* bbox contains the match. 
                        // For simplicity in this constrained env: 
                        // If detected text *contains* the item name, we define region by the centroid of detected text.
                        if (fullText.toLowerCase().includes(item.name.toLowerCase())) {
                            // Valid match globally. Assign to region based on word position?
                            // Issue: "Blue Moon" might have "Blue" in R1 and "Moon" in R1.
                            // We assume events don't span across the separator.
                            if (txt.includes(item.name.toLowerCase().split(' ')[0])) {
                                currentMatches.set(item.name, { item: item, region: region });
                            }
                        }
                    });
                });

                // Fallback: If map is empty but fullText has match, assign to R1 (Uni) or try to guess
                if (currentMatches.size === 0) {
                    moonWeatherList.forEach(item => {
                        if (fullText.toLowerCase().includes(item.name.toLowerCase())) {
                             // Default to R1 if we can't place it, or R2 if text is clearly at bottom?
                             // Without word-level bbox for the specific phrase, it's hard.
                             // We'll assume R1 for Uni. For Dual, if we have words, we use them.
                             // If no words array, we can't support Smart Zoom Lock properly per region.
                             // Proceeding with Found Logic updates:
                             currentMatches.set(item.name, { item: item, region: 1 }); // Fallback
                        }
                    });
                }

                // Process Matches
                currentMatches.forEach((matchData, name) => {
                    const { item, region } = matchData;
                    
                    // Update Lock State
                    if (region === 1) foundR1 = true;
                    if (region === 2) foundR2 = true;

                    if (activeItems[name]) {
                        // Extend
                        if(activeItems[name].timeout) clearTimeout(activeItems[name].timeout);
                        activeItems[name].timeout = null;
                    } else {
                        // Start
                        addLog(`**[START]** ${name} (R${region})`);
                        activeItems[name] = { item, start: Date.now(), timeout: null };
                        sendDiscordNotification(item, "start");
                        renderActiveStatus();
                    }
                });

                // Check for Ended Events (Grace Period)
                Object.keys(activeItems).forEach(name => {
                    if (!currentMatches.has(name)) {
                        const state = activeItems[name];
                        if (!state.timeout) {
                            state.endRef = Date.now();
                            const GRACE = (parseInt(gracePeriodSecondsInput.value)||5) * 1000;
                            state.timeout = setTimeout(() => {
                                if (activeItems[name] && activeItems[name].timeout) {
                                    const dur = state.endRef - state.start;
                                    addLog(`**[END]** ${name}`);
                                    addRecentEvent(state.item, dur, state.start);
                                    sendDiscordNotification(state.item, "end", dur);
                                    delete activeItems[name]; renderActiveStatus();
                                }
                            }, GRACE);
                            renderActiveStatus();
                        }
                    }
                });

                // --- Smart Zoom Update ---
                
                // Region 1 Logic
                if (foundR1) {
                    if (!lock1) { lock1 = true; addLog(`**[ZOOM]** R1 Locked ${zoom1}x`); }
                } else {
                    if (lock1) { lock1 = false; } // Unlock if lost
                    // Cycle
                    zoom1++; if (zoom1 > 5) zoom1 = 1;
                }

                // Region 2 Logic
                if (scanMode === 'dual') {
                    if (foundR2) {
                        if (!lock2) { lock2 = true; addLog(`**[ZOOM]** R2 Locked ${zoom2}x`); }
                    } else {
                        if (lock2) { lock2 = false; }
                        zoom2++; if (zoom2 > 5) zoom2 = 1;
                    }
                }

                // Update Badges
                document.getElementById('zoom1Status').innerHTML = `R1: ${zoom1}x ${lock1 ? '<i class="bi bi-lock-fill"></i>' : ''}`;
                document.getElementById('zoom2Status').innerHTML = `R2: ${zoom2}x ${lock2 ? '<i class="bi bi-lock-fill"></i>' : ''}`;

                // Cleanup
                isOcrBusy = false;
                Tesseract.release(worker).then(() => { worker = null; });
            }).catch(e => { console.error(e); isOcrBusy = false; });
        }

        function applyImagePreprocessing(ctx, w, h) {
            const imgData = ctx.getImageData(0, 0, w, h);
            const d = imgData.data;
            const threshold = 180;
            for (let i = 0; i < d.length; i += 4) {
                const avg = 0.2126 * d[i] + 0.7152 * d[i + 1] + 0.0722 * d[i + 2];
                const v = avg > threshold ? 0 : 255;
                d[i] = d[i+1] = d[i+2] = v;
            }
            ctx.putImageData(imgData, 0, 0);
        }

        // --- Drag & Select (Dual Aware) ---
        const regionSelectionModal = document.getElementById('regionSelectionModal');
        const selectionCanvas = document.getElementById('selectionCanvas');
        let selectionCtx = null, isDragging = false, startX=0, startY=0, endX=0, endY=0, animId=null;

        function startRegionSelection() {
            if (!localStream) { showToast("Connect screen first!", "error"); return; }
            dragSelectionStep = 1;
            
            const title = document.getElementById('regionSelectionTitle');
            if (scanMode === 'dual') title.innerHTML = `<i class="bi bi-1-square"></i> Select Region 1 (Top)`;
            else title.innerHTML = `<i class="bi bi-mouse"></i> Drag to select area`;
            
            selectionCanvas.width = videoElement.videoWidth;
            selectionCanvas.height = videoElement.videoHeight;
            selectionCtx = selectionCanvas.getContext('2d');
            regionSelectionModal.style.display = 'flex';
            animId = requestAnimationFrame(renderSelectionLoop);
        }

        function renderSelectionLoop() {
            if (regionSelectionModal.style.display === 'none') return;
            selectionCtx.drawImage(videoElement, 0, 0, selectionCanvas.width, selectionCanvas.height);
            
            const w = endX - startX; const h = endY - startY;
            if (w !== 0 && h !== 0) {
                selectionCtx.strokeStyle = 'red'; selectionCtx.lineWidth = 3; selectionCtx.strokeRect(startX, startY, w, h);
                selectionCtx.fillStyle = 'rgba(255, 0, 0, 0.2)'; selectionCtx.fillRect(startX, startY, w, h);
            }
            animId = requestAnimationFrame(renderSelectionLoop);
        }

        function closeRegionSelection() {
            cancelAnimationFrame(animId);
            regionSelectionModal.style.display = 'none';
            dragSelectionStep = 0;
        }

        function confirmRegionSelection() {
            let x = Math.min(startX, endX), y = Math.min(startY, endY), w = Math.abs(endX - startX), h = Math.abs(endY - startY);
            if (w < 10 || h < 10) { showToast("Too small!", "error"); return; }

            const title = document.getElementById('regionSelectionTitle');
            
            if (dragSelectionStep === 1) {
                // Save R1
                regionXInput.value = Math.round(x); regionYInput.value = Math.round(y); regionWInput.value = Math.round(w); regionHInput.value = Math.round(h);
                
                if (scanMode === 'dual') {
                    // Move to Step 2
                    dragSelectionStep = 2;
                    title.innerHTML = `<i class="bi bi-2-square"></i> Select Region 2 (Bottom)`;
                    // Reset visual selection
                    startX=0; startY=0; endX=0; endY=0;
                    showToast("Region 1 set. Now select Region 2.");
                } else {
                    // Done
                    updatePreviewAndSize(); saveSettings(); closeRegionSelection();
                    showToast("Region set!");
                }
            } else if (dragSelectionStep === 2) {
                // Save R2
                region2XInput.value = Math.round(x); region2YInput.value = Math.round(y); region2WInput.value = Math.round(w); region2HInput.value = Math.round(h);
                updatePreviewAndSize(); saveSettings(); closeRegionSelection();
                showToast("Dual Regions set!");
            }
        }

        selectionCanvas.addEventListener('mousedown', e => { isDragging=true; const r=selectionCanvas.getBoundingClientRect(); const sx=selectionCanvas.width/r.width; const sy=selectionCanvas.height/r.height; startX=(e.clientX-r.left)*sx; startY=(e.clientY-r.top)*sy; endX=startX; endY=startY; });
        selectionCanvas.addEventListener('mousemove', e => { if(!isDragging)return; const r=selectionCanvas.getBoundingClientRect(); const sx=selectionCanvas.width/r.width; const sy=selectionCanvas.height/r.height; endX=(e.clientX-r.left)*sx; endY=(e.clientY-r.top)*sy; });
        selectionCanvas.addEventListener('mouseup', () => isDragging=false);

        // --- Helpers ---
        function renderActiveStatus() {
            const list = Object.values(activeItems);
            
            if(list.length === 0) { 
                cooldownsPlaceholder.style.display='block'; 
                activeMoonsSection.classList.add('d-none');
                activeWeatherSection.classList.add('d-none');
                cooldownTimerLog.textContent = ocrScanInterval ? "Scanning..." : "Idle"; 
                return; 
            }
            
            cooldownsPlaceholder.style.display='none';
            
            const moons = list.filter(s => s.item.type === 'Moon');
            const weathers = list.filter(s => s.item.type === 'Weather');
            
            const generateHTML = (items) => items.map(s => {
                const el = Date.now() - s.start;
                const txt = s.timeout ? `<span class="text-danger">Grace...</span>` : `Active ${formatDuration(el)}`;
                return `<div class="list-group-item d-flex justify-content-between align-items-center"><div><strong>${s.item.name}</strong></div><small>${txt}</small></div>`;
            }).join('');

            if(moons.length > 0) {
                activeMoonsSection.classList.remove('d-none');
                activeMoonsList.innerHTML = generateHTML(moons);
            } else {
                activeMoonsSection.classList.add('d-none');
            }

            if(weathers.length > 0) {
                activeWeatherSection.classList.remove('d-none');
                activeWeatherList.innerHTML = generateHTML(weathers);
            } else {
                activeWeatherSection.classList.add('d-none');
            }

            cooldownTimerLog.textContent = `Active: ${list.length}`;
        }
        function addLog(msg) { logContentDiv.innerHTML = `<span style="color:#adb5bd;">[${new Date().toLocaleTimeString()}]</span> ${msg}<br>` + logContentDiv.innerHTML; }
        function clearLogs() { logContentDiv.innerHTML = ""; addLog("Logs cleared."); };
        function showToast(msg, type='success') {
            const t = document.createElement('div'); t.className = `custom-toast ${type}`;
            t.innerHTML = `<span>${msg}</span>`;
            let c = document.querySelector('.toast-container'); if(!c){c=document.createElement('div');c.className='toast-container';document.body.appendChild(c);}
            c.appendChild(t); setTimeout(() => t.remove(), 3000);
        }
        function formatChanceToPercent(input) {
            if (!input) return '';
            let clean = input.toString().toLowerCase().replace(/,/g, '');
            if(clean.includes('/')) {
                let [numStr, denStr] = clean.split('/');
                let num = parseFloat(numStr);
                let den = parseFloat(denStr);
                if(denStr.includes('k')) den = parseFloat(denStr.replace('k', '')) * 1000;
                if (!isNaN(num) && !isNaN(den) && den !== 0) {
                    return parseFloat(((num / den) * 100).toFixed(5)) + '%';
                }
            }
            return input;
        }

        function formatDuration(ms) {
            const sec = Math.floor(ms / 1000);
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }
        
        function refreshTooltips() { [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map(e=>new bootstrap.Tooltip(e)); }
        
        // --- Webhook & Event Lists Logic ---
        
        // RENDER EVENT LIST (With Slide-to-Delete)
        function renderList() {
            moonWeatherList.sort((a,b)=>b.multiplier-a.multiplier);
            const moons=moonWeatherList.filter(i=>i.type==='Moon'), weathers=moonWeatherList.filter(i=>i.type==='Weather');
            
            const gen = (l) => l.length ? l.map((i,idx)=> {
                const originalIndex = moonWeatherList.indexOf(i);
                const pct = formatChanceToPercent(i.chances);
                return `
                <div class="slide-reveal-wrapper">
                    <div class="slide-reveal-content p-2 border-bottom d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${i.name}</strong> 
                            <span class="badge bg-secondary">${i.multiplier}x</span>
                            ${pct ? `<span class="badge bg-info text-dark" style="font-size:0.7em">${pct}</span>` : ''}
                        </div>
                        <i class="bi bi-chevron-left text-muted opacity-25"></i>
                    </div>
                    <div class="slide-reveal-action">
                        <div class="slide-btn slide-btn-edit" onclick="showItemModal(${originalIndex})">
                            <i class="bi bi-pencil"></i>
                        </div>
                        <div class="slide-btn slide-btn-delete" onclick="removeItem(${originalIndex})">
                            <i class="bi bi-trash"></i>
                        </div>
                    </div>
                </div>`;
            }).join('') : '<p class="text-muted small text-center p-2">None.</p>';

            document.getElementById('moonListContainer').innerHTML=gen(moons);
            document.getElementById('weatherListContainer').innerHTML=gen(weathers);
            
            // Modal Previews
            document.getElementById('modalMoonPreview').innerHTML = moons.map(i=>`<div class="px-2 py-1 border-bottom small">${i.name}</div>`).join('') || '<p class="small text-muted">None</p>';
            document.getElementById('modalWeatherPreview').innerHTML = weathers.map(i=>`<div class="px-2 py-1 border-bottom small">${i.name}</div>`).join('') || '<p class="small text-muted">None</p>';
            
            updateItemListDropdown();
        }

        // RENDER WEBHOOK LIST (Restored - Reverted Slide-to-Reveal)
        function renderWebhookList() {
            const c = document.getElementById('webhookListContainer');
            if(!webhookList.length) { c.innerHTML='<p class="text-muted small text-center">No webhooks configured.</p>'; return; }
            
            const totalMoons = moonWeatherList.filter(i => i.type === 'Moon').length;
            const totalWeathers = moonWeatherList.filter(i => i.type === 'Weather').length;
            
            const activeWebhooks = webhookList.map((w, i) => ({...w, originalIndex: i})).filter(w => w.active);
            const inactiveWebhooks = webhookList.map((w, i) => ({...w, originalIndex: i})).filter(w => !w.active);

            const renderItem = (w) => {
                const moonSubs = moonWeatherList.filter(i => i.type === 'Moon' && (i.webhookIds || []).includes(w.id)).length;
                const weatherSubs = moonWeatherList.filter(i => i.type === 'Weather' && (i.webhookIds || []).includes(w.id)).length;
                const moonChecked = (totalMoons > 0 && moonSubs === totalMoons) ? 'checked' : '';
                const weatherChecked = (totalWeathers > 0 && weatherSubs === totalWeathers) ? 'checked' : '';

                return `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="overflow-hidden me-2 flex-grow-1">
                            <div class="d-flex align-items-center gap-2">
                                <strong class="text-truncate">${w.description}</strong>
                            </div>
                            <small class="text-muted d-block text-truncate" style="font-size: 0.75rem;">${w.url}</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="form-check form-switch m-0" title="Enable/Disable Webhook Global">
                                <input class="form-check-input" type="checkbox" ${w.active ? 'checked' : ''} onchange="toggleWb(${w.originalIndex})">
                            </div>
                            <button onclick="showWebhookModal(${w.originalIndex})" class="btn btn-sm btn-outline-secondary" title="Edit Webhook">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button onclick="removeWebhook(${w.originalIndex})" class="btn btn-sm btn-outline-danger" title="Delete Webhook">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-3 pt-2 border-top bg-body-tertiary rounded px-2 py-1">
                        <small class="text-muted fw-bold" style="font-size: 0.7rem;">Notify For:</small>
                        
                        <div class="form-check form-check-inline m-0 d-flex align-items-center">
                            <input class="form-check-input me-1" type="checkbox" id="wb-moon-${w.id}" ${moonChecked} onchange="toggleWebhookSubscription(${w.id}, 'Moon')">
                            <label class="form-check-label small cursor-pointer text-primary" for="wb-moon-${w.id}">
                                <i class="bi bi-moon-stars"></i> Moons <span class="text-muted" style="font-size:0.75em">(${moonSubs}/${totalMoons})</span>
                            </label>
                        </div>

                        <div class="form-check form-check-inline m-0 d-flex align-items-center">
                            <input class="form-check-input me-1" type="checkbox" id="wb-weather-${w.id}" ${weatherChecked} onchange="toggleWebhookSubscription(${w.id}, 'Weather')">
                            <label class="form-check-label small cursor-pointer text-warning-emphasis" for="wb-weather-${w.id}">
                                <i class="bi bi-cloud-haze"></i> Weathers <span class="text-muted" style="font-size:0.75em">(${weatherSubs}/${totalWeathers})</span>
                            </label>
                        </div>

                        <div class="ms-auto">
                            <button class="btn btn-sm btn-outline-secondary py-0 px-2" style="font-size: 0.75rem;" onclick="showWebhookEventsModal(${w.originalIndex})" title="Select Specific Events">
                                <i class="bi bi-list-check"></i> Select
                            </button>
                        </div>
                    </div>
                </div>
                <script>
                    (function(){
                        const m = document.getElementById('wb-moon-${w.id}');
                        if(m) m.indeterminate = ${moonSubs > 0 && moonSubs < totalMoons};
                        const w = document.getElementById('wb-weather-${w.id}');
                        if(w) w.indeterminate = ${weatherSubs > 0 && weatherSubs < totalWeathers};
                    })();
                <\/script>`;
            };

            let html = '';
            if(activeWebhooks.length > 0) {
                html += `<h6 class="text-success small fw-bold px-1 mb-1 mt-2">Active Webhooks</h6>` + activeWebhooks.map(renderItem).join('');
            }
            if(inactiveWebhooks.length > 0) {
                html += `<h6 class="text-secondary small fw-bold px-1 mb-1 mt-3">Inactive Webhooks</h6>` + inactiveWebhooks.map(renderItem).join('');
            }
            
            c.innerHTML = html;
        };

        function toggleWebhookSubscription(webhookId, type) {
            const targetItems = moonWeatherList.filter(i => i.type === type);
            if (targetItems.length === 0) { showToast(`No ${type}s to assign.`, 'info'); return; }

            const allSubscribed = targetItems.every(i => (i.webhookIds || []).includes(webhookId));
            
            targetItems.forEach(item => {
                if (!item.webhookIds) item.webhookIds = [];
                if (allSubscribed) {
                    item.webhookIds = item.webhookIds.filter(id => id !== webhookId);
                } else {
                    if (!item.webhookIds.includes(webhookId)) item.webhookIds.push(webhookId);
                }
            });
            
            saveSettings();
            renderList();
            renderWebhookList();
            showToast(`${allSubscribed ? "Unsubscribed from" : "Subscribed to"} all ${type}s.`);
        }

        function showWebhookEventsModal(webhookIndex) {
            if (!webhookList[webhookIndex]) return;
            currentEditingWebhookIndex = webhookIndex;
            const webhook = webhookList[webhookIndex];
            webhookEventsModalTitle.innerHTML = `Select events for <strong>${webhook.description}</strong>:`;
            if(webhookEventsSearchInput) webhookEventsSearchInput.value = "";
            renderWebhookEventsList(webhook.id);
            webhookEventsModal.style.display = 'flex';
        }

        function hideWebhookEventsModal() {
            webhookEventsModal.style.display = 'none';
            currentEditingWebhookIndex = -1;
        }

        function renderWebhookEventsList(webhookId, filterText = "") {
            const sortedEvents = [...moonWeatherList].sort((a, b) => {
                if(a.type !== b.type) return a.type === 'Moon' ? -1 : 1;
                if(b.multiplier !== a.multiplier) return b.multiplier - a.multiplier;
                return a.name.localeCompare(b.name);
            });

            if (sortedEvents.length === 0) {
                webhookEventsListContainer.innerHTML = '<div class="alert alert-warning small mb-0">No events found.</div>';
                return;
            }

            let html = '';
            let lastType = null;
            
            sortedEvents.forEach(item => {
                if (filterText && !item.name.toLowerCase().includes(filterText.toLowerCase())) return;
                
                if (item.type !== lastType) {
                    const typeColor = item.type === 'Moon' ? 'text-primary' : 'text-warning-emphasis';
                    html += `<div class="small fw-bold ${typeColor} bg-body-tertiary border-bottom pt-2 pb-1 sticky-top mb-1" style="top:0;">${item.type}s</div>`;
                    lastType = item.type;
                }

                const isChecked = (item.webhookIds || []).includes(webhookId) ? 'checked' : '';
                
                html += `
                <div class="webhook-select-item d-flex align-items-center justify-content-between p-2 border-bottom" onclick="toggleWebhookEventCheckbox('${item.id}')">
                    <div class="overflow-hidden me-2">
                        <div class="d-flex align-items-center gap-1 small fw-bold">${item.name}</div>
                        <div class="small text-muted" style="font-size: 0.75em;">${item.multiplier}x Multiplier</div>
                    </div>
                    <div class="form-check m-0">
                        <input class="form-check-input webhook-event-checkbox" type="checkbox" value="${item.id}" id="weCheck-${item.id}" ${isChecked} onclick="event.stopPropagation()">
                    </div>
                </div>`;
            });
            webhookEventsListContainer.innerHTML = html || '<div class="text-center text-muted small p-3">No matching events found.</div>';
        }

        function filterWebhookEventsSelection() {
            if (currentEditingWebhookIndex === -1) return;
            const webhookId = webhookList[currentEditingWebhookIndex].id;
            const filterText = webhookEventsSearchInput.value.trim();
            renderWebhookEventsList(webhookId, filterText);
        }

        function toggleWebhookEventCheckbox(id) {
            const cb = document.getElementById(`weCheck-${id}`);
            if (cb) cb.checked = !cb.checked;
        }

        function toggleSelectAllEventsForWebhook(selectAll) {
            const checkboxes = document.querySelectorAll('.webhook-event-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        function saveWebhookEvents() {
            if (currentEditingWebhookIndex === -1) return;
            const webhookId = webhookList[currentEditingWebhookIndex].id;
            const checkboxes = document.querySelectorAll('.webhook-event-checkbox');
            
            checkboxes.forEach(cb => {
                const itemId = parseInt(cb.value);
                const item = moonWeatherList.find(i => i.id === itemId);
                if (item) {
                    if (!item.webhookIds) item.webhookIds = [];
                    if (cb.checked) {
                        if (!item.webhookIds.includes(webhookId)) item.webhookIds.push(webhookId);
                    } else {
                        item.webhookIds = item.webhookIds.filter(id => id !== webhookId);
                    }
                }
            });

            saveSettings();
            renderList();
            renderWebhookList();
            hideWebhookEventsModal();
            showToast(`Events updated.`);
        }

        function toggleWb(i) { webhookList[i].active = !webhookList[i].active; saveSettings(); renderWebhookList(); }
        
        function removeWebhook(i) { 
            const wb = webhookList[i];
            if(confirm(`Delete webhook "${wb.description}"?`)) { 
                webhookList.splice(i,1); 
                saveSettings(); 
                renderWebhookList(); 
                showToast(`Webhook "${wb.description}" deleted.`); 
            } 
        }

        function updateSearchDatalist() {
            const dl = document.getElementById('eventNamesList');
            dl.innerHTML = '';
            const allNames = new Set();
            moonWeatherList.forEach(i => allNames.add(i.name));
            const evs = JSON.parse(localStorage.getItem('dailyEvents')) || {};
            Object.values(evs).flat().forEach(e => allNames.add(e.name));
            [...allNames].sort().forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                dl.appendChild(opt);
            });
        }

        // RENDER HISTORY (With Slide-to-Delete)
        function renderRecentEvents() {
            const date = document.getElementById('eventDatePicker').value;
            const evs = JSON.parse(localStorage.getItem('dailyEvents')) || {};
            const dayEvents = evs[date] || [];
            const container = document.getElementById('recentEventsList');
            
            if(!dayEvents.length) { container.innerHTML='<p class="text-center text-muted small mt-2">No events found.</p>'; return; }
            
            const search = document.getElementById('eventSearchInput').value.toLowerCase();
            const typeFilter = document.querySelector('input[name="typeFilter"]:checked').value;
            
            let filtered = dayEvents.map((e, index) => ({...e, originalIndex: index})).filter(e => {
                if(typeFilter !== 'All' && e.type !== typeFilter) return false;
                if(search && !e.name.toLowerCase().includes(search)) return false;
                return true;
            });
            
            filtered.sort((a,b) => eventSortOrder === 'desc' ? b.start - a.start : a.start - b.start);
            
            container.innerHTML = `<div class="list-group list-group-flush">` + filtered.map(e => `
                <div class="slide-reveal-wrapper">
                    <div class="slide-reveal-content p-2 border-bottom">
                        <div class="d-flex justify-content-between">
                            <strong>${e.name}</strong>
                            <small class="text-muted">${new Date(e.start).toLocaleTimeString()}</small>
                        </div>
                        <small class="text-muted">Duration: ${formatDuration(e.duration)}</small>
                    </div>
                    <div class="slide-reveal-action" style="width:50px"> 
                        <div class="slide-btn slide-btn-delete" style="width:100%" onclick="deleteHistoryItem('${date}', ${e.originalIndex})">
                            <i class="bi bi-trash"></i>
                        </div>
                    </div>
                </div>
            `).join('') + `</div>`;
        }
        
        function deleteHistoryItem(date, index) {
            const evs = JSON.parse(localStorage.getItem('dailyEvents')) || {};
            if(evs[date]) {
                const eventName = evs[date][index].name;
                evs[date].splice(index, 1);
                localStorage.setItem('dailyEvents', JSON.stringify(evs));
                renderRecentEvents();
                showToast(`Event "${eventName}" deleted from history.`);
            }
        }
        
        // --- Statistics & Charting Logic (Restored) ---
        function getTimeRange() {
            const s = document.getElementById('statsDateStart').value.split('-');
            const e = document.getElementById('statsDateEnd').value.split('-');
            const start = new Date(s[0], s[1]-1, s[2], 0, 0, 0);
            const end = new Date(e[0], e[1]-1, e[2], 23, 59, 59, 999);
            return { start, end };
        }

        function updateItemListDropdown() {
            const { start, end } = getTimeRange();
            const typeFilter = document.querySelector('input[name="statsTypeFilter"]:checked').value;
            const dataList = document.getElementById('statsItemDataList');
            const dailyEvents = JSON.parse(localStorage.getItem('dailyEvents')) || {};
            const availableItems = new Set();

            Object.keys(dailyEvents).forEach(dateKey => {
                const events = dailyEvents[dateKey];
                events.forEach(event => {
                    if (event.start >= start.getTime() && event.start <= end.getTime()) {
                        if (typeFilter === 'All' || event.type === typeFilter) {
                            availableItems.add(event.name);
                        }
                    }
                });
            });

            dataList.innerHTML = '';
            Array.from(availableItems).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                dataList.appendChild(option);
            });
            updateEventStatistics(); 
        };

        function getItemColor(name, type) {
            const n = name.toLowerCase();
            if (n.includes('blood') || n.includes('red')) return 'rgba(220, 53, 69, 0.7)';
            if (n.includes('blue') || n.includes('rain')) return 'rgba(13, 110, 253, 0.7)';
            if (n.includes('gold') || n.includes('sun')) return 'rgba(255, 193, 7, 0.7)';
            if (n.includes('void') || n.includes('dark')) return 'rgba(33, 37, 41, 0.7)';
            if (type === 'Moon') return 'rgba(111, 66, 193, 0.7)';
            return 'rgba(253, 126, 20, 0.7)';
        }

        function updateEventStatistics() {
            const dailyEvents = JSON.parse(localStorage.getItem('dailyEvents')) || {};
            const { start, end } = getTimeRange();
            const typeFilter = document.querySelector('input[name="statsTypeFilter"]:checked').value;
            const itemFilter = document.getElementById('statsItemFilter').value.toLowerCase();
            const metric = document.getElementById('statsMetricFilter').value; 
            
            const aggregated = {};
            
            Object.keys(dailyEvents).forEach(dateKey => {
                dailyEvents[dateKey].forEach(event => {
                    if (event.start >= start.getTime() && event.start <= end.getTime()) {
                        if ((typeFilter === 'All' || event.type === typeFilter) && (!itemFilter || event.name.toLowerCase().includes(itemFilter))) {
                            if (!aggregated[event.name]) aggregated[event.name] = { count: 0, totalDuration: 0, type: event.type };
                            aggregated[event.name].count++;
                            aggregated[event.name].totalDuration += event.duration;
                        }
                    }
                });
            });
            
            const labels = [], data = [], colors = [];
            const sortedKeys = Object.keys(aggregated).sort((a, b) => {
                const va = metric === 'count' ? aggregated[a].count : aggregated[a].totalDuration;
                const vb = metric === 'count' ? aggregated[b].count : aggregated[b].totalDuration;
                return vb - va;
            });

            sortedKeys.forEach(key => {
                labels.push(key);
                data.push(metric === 'count' ? aggregated[key].count : (aggregated[key].totalDuration / aggregated[key].count / 60000));
                colors.push(getItemColor(key, aggregated[key].type));
            });

            const placeholder = document.getElementById('chartPlaceholder');
            if (data.length === 0) {
                placeholder.style.display = 'block';
                if (eventStatsChartInstance) { eventStatsChartInstance.destroy(); eventStatsChartInstance = null; }
            } else {
                placeholder.style.display = 'none';
                renderEventStatsChart(data, labels, colors, metric === 'avgTime' ? "Avg Time" : "Occurrences", metric);
            }
        };

        function renderEventStatsChart(data, labels, bgColors, labelText, metricType) {
            const ctx = document.getElementById('eventStatsChart').getContext('2d');
            if (eventStatsChartInstance) eventStatsChartInstance.destroy();
            
            eventStatsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: labelText, data: data, backgroundColor: bgColors, borderWidth: 1 }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (metricType === 'avgTime') {
                                        const sec = Math.round(value * 60);
                                        const m = Math.floor(sec / 60);
                                        const s = sec % 60;
                                        return `${m}m ${s}s`;
                                    }
                                    return value;
                                }
                            }
                        } 
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (metricType === 'avgTime') {
                                            const sec = Math.round(context.parsed.y * 60);
                                            const m = Math.floor(sec / 60);
                                            const s = sec % 60;
                                            label += `${m}m ${s}s`;
                                        } else {
                                            label += context.parsed.y;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        function updateUploadLabel(input) {
            if(input.files[0]) {
                Papa.parse(input.files[0], { header:true, skipEmptyLines:true, complete: (res) => {
                    let c=0;
                    res.data.forEach(row => {
                        const n=row.Name||row.name, t=row.Type||row.type, m=parseFloat(row.Multiplier||row.multiplier);
                        if(n && t && m && !moonWeatherList.some(x=>x.name===n)) {
                            moonWeatherList.push({id:Date.now()+c, name:n, type:t, multiplier:m, chances: row.Chances||row.chances||""});
                            c++;
                        }
                    });
                    if(c>0) { saveSettings(); renderList(); showToast(`Imported ${c} items`); }
                }});
            }
        }
        function exportEvents() {
            const csv = Papa.unparse(moonWeatherList.map(i => ({Name:i.name, Type:i.type, Multiplier:i.multiplier, Chances:i.chances||""})));
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'fyp_events.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showToast("Exported CSV file.");
        }

        function sendDiscordNotification(item, status, dur) {
            const activeHooks = webhookList.filter(w => w.active);
            if(!activeHooks.length) return;
            
            const msg = status === 'start' 
                ? `${item.name} (Gives **${item.multiplier}x!**) **has started!**` 
                : `${item.name} **ended!** Duration: ${formatDuration(dur)}`;

            activeHooks.forEach(h => {
                fetch(h.url, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({content: msg}) 
                })
                .then(r => {
                    if (r.ok) addLog(`[DISCORD] Sent ${status} notification to "${h.description}"`);
                    else addLog(`[DISCORD] Failed to send ${status} notification to "${h.description}"`);
                })
                .catch(e => addLog(`[DISCORD] Error sending ${status} notification to "${h.description}": ${e.message}`));
            });
        }
        
        function addRecentEvent(item, dur, start) {
            // Use local date for storage key instead of UTC
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const k = `${year}-${month}-${day}`;
            
            const evs = JSON.parse(localStorage.getItem('dailyEvents')) || {};
            if(!evs[k]) evs[k] = [];
            evs[k].push({name:item.name, type:item.type, duration:dur, start});
            localStorage.setItem('dailyEvents', JSON.stringify(evs));
            renderRecentEvents();
            // Trigger stats update immediately
            updateItemListDropdown();
        }

        // --- Modals logic ---
        function showItemModal(i) { 
            const m = document.getElementById('itemModal'); 
            m.style.display='flex'; 
            document.getElementById('itemIndex').value=i; 
            
            if(i > -1 && moonWeatherList[i]) {
                const item = moonWeatherList[i];
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemType').value = item.type;
                document.getElementById('itemMultiplier').value = item.multiplier;
                document.getElementById('itemChances').value = item.chances || '';
                document.getElementById('modalTitle').textContent = 'Edit Event';
                document.getElementById('formSubmitButton').textContent = 'Update';
            } else {
                document.getElementById('itemForm').reset();
                document.getElementById('itemIndex').value = -1;
                document.getElementById('itemType').value = 'Moon'; // Default
                document.getElementById('itemMultiplier').value = 3;
                document.getElementById('modalTitle').textContent = 'Add Event';
                document.getElementById('formSubmitButton').textContent = 'Save';
            }
        }
        function hideItemModal() { document.getElementById('itemModal').style.display='none'; }
        
        document.getElementById('itemForm').addEventListener('submit', e=>{
            e.preventDefault(); const nm=document.getElementById('itemName').value, tp=document.getElementById('itemType').value, mu=parseFloat(document.getElementById('itemMultiplier').value), ch=document.getElementById('itemChances').value;
            const idx=parseInt(document.getElementById('itemIndex').value);
            if(idx>-1){ moonWeatherList[idx].name=nm; moonWeatherList[idx].type=tp; moonWeatherList[idx].multiplier=mu; moonWeatherList[idx].chances=ch; }
            else moonWeatherList.push({id:Date.now(), name:nm, type:tp, multiplier:mu, chances:ch});
            saveSettings(); renderList(); hideItemModal();
            showToast(idx > -1 ? `Event "${nm}" updated.` : `Event "${nm}" added.`);
        });
        function removeItem(i) { 
            const item = moonWeatherList[i];
            if(confirm(`Delete event "${item.name}"?`)) { 
                moonWeatherList.splice(i,1); 
                saveSettings(); 
                renderList(); 
                showToast(`Event "${item.name}" deleted.`); 
            } 
        };
        
        window.onclick = e => { if(e.target.classList.contains('custom-modal-overlay')) { 
            hideItemModal(); document.getElementById('webhookModal').style.display='none'; 
            document.getElementById('configModal').style.display='none'; closeRegionSelection();
        }};
        
        function showWebhookModal(i) { 
            const m = document.getElementById('webhookModal');
            m.style.display='flex'; 
            document.getElementById('webhookIndex').value=i;
            
            if(i > -1 && webhookList[i]) {
                const wb = webhookList[i];
                document.getElementById('modalWebhookDescription').value = wb.description;
                document.getElementById('modalWebhookUrl').value = wb.url;
                document.getElementById('webhookModalTitle').textContent = 'Edit Webhook';
            } else {
                document.getElementById('webhookForm').reset();
                document.getElementById('webhookIndex').value = -1;
                document.getElementById('webhookModalTitle').textContent = 'Add Webhook';
            }
        }
        function hideWebhookModal() { document.getElementById('webhookModal').style.display='none'; }
        document.getElementById('webhookForm').addEventListener('submit', e => {
            e.preventDefault(); const d=document.getElementById('modalWebhookDescription').value, u=document.getElementById('modalWebhookUrl').value;
            const i=parseInt(document.getElementById('webhookIndex').value);
            if(i>-1) { webhookList[i].description=d; webhookList[i].url=u; } else webhookList.push({id:Date.now(), description:d, url:u, active:true});
            saveSettings(); renderWebhookList(); hideWebhookModal();
            showToast(i > -1 ? `Webhook "${d}" updated.` : `Webhook "${d}" added.`);
        });
        function testNewWebhook() {
             const url = document.getElementById('modalWebhookUrl').value;
             if(!url) return;
             fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content:" **Test Message** from FYP Notifier! If you see this, your webhook is working correctly."})})
                .then(r=>r.ok?showToast('Sent!'):showToast('Failed','error'));
        }

        function toggleEventSortOrder() { eventSortOrder = eventSortOrder==='desc'?'asc':'desc'; renderRecentEvents(); }
        function clearHistory() { 
            const d = document.getElementById('eventDatePicker').value;
            const evs = JSON.parse(localStorage.getItem('dailyEvents')) || {};
            if(evs[d]) { delete evs[d]; localStorage.setItem('dailyEvents', JSON.stringify(evs)); renderRecentEvents(); showToast('History Cleared'); }
        }

        function openTab(e,t) {
            document.querySelectorAll('.tab-content-wrapper').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active','fw-bold'));
            document.getElementById(t).classList.add('active'); e.currentTarget.classList.add('active','fw-bold');
        };
    </script>
</body>
</html>